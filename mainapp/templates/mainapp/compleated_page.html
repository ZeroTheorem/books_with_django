{%extends 'base.html'%}
{%load static%}
{%block css%}
<link rel="stylesheet" href="{% static 'css/main_page.css'%} ">
{%endblock%}
{%block content%}
{%for el in result%}
<div class=box>
    {%load thumbnail%}
    <a href="{{el.book_image.url}}">
        <img src="{% thumbnail el.book_image 200x0%}" alt="">
    </a>
    <input type="submit" class="btn btn-outline-light" value="Перейти" data-bs-toggle="modal" id="reveal_input"
        data-bs-target="#{{el.pk}}" data-bs-whatever="@getbootstrap" />
    {%with total_likes=el.likes.count users_like=el.likes.all%}
    <p class="total">{{total_likes}}</p>
    <a href="#" data-id="{{el.id}}" data-action="{%if request.user in users_like%}un{%endif%}like" class="like button">
        {%if request.user not in users_like%}
        like
        {%else%}
        unlike
        {%endif%}
        {%endwith%}
    </a>
    <div class="modal fade" id="{{el.pk}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel1"></h1>

                </div>
                <div class="modal-body">
                    <div class="input_group">
                        <ul class="list-group list-group-flush">

                            <li class="list-group-item">Автор:{{el.author_name}} </li>
                            <li class="list-group-item">Страниц: {{el.total_page}}</li>
                            <li class="list-group-item">Год: {{el.year_of_writing}}</li>
                            <li class="list-group-item" id="description">{{el.description}}</li>

                        </ul>

                    </div>
                    <form action="" method="post">
                        {% csrf_token %}
                        <button class="btn btn-outline-danger" id="delete_btn">Удалить</button>
                        <input type="hidden" name="book_id" value="{{el.pk}}" />
                        <input type="hidden" name="delete_book_image" value="{{el.book_image}}" />
                    </form>
                </div>

            </div>
        </div>
    </div>

</div>
{%endfor%}
{%endblock%}
{%block script%}
<script src="//cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
<script>
    const csrftoken = Cookies.get('csrftoken')
    const url = '{% url "mainapp:like" %}';
    let options = {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        mode: 'same-origin'
    }

    document.querySelector('a.like')
        .addEventListener('click', function (e) {
            e.preventDefault();
            let likeButton = this;

            // add request body
            let formData = new FormData();
            formData.append('id', likeButton.dataset.id);
            formData.append('action', likeButton.dataset.action);
            options['body'] = formData;
            console.log(options)

            // send HTTP request
            fetch(url, options)
                .then(response => response.json())
                .then(data => {
                    if (data['status'] === 'ok') {
                        let previousAction = likeButton.dataset.action;

                        // toggle button text and data-action
                        let action = previousAction === 'like' ? 'unlike' : 'like';
                        likeButton.dataset.action = action;
                        likeButton.innerHTML = action;

                        // update like count
                        let likeCount = document.querySelector('.total');
                        let totalLikes = parseInt(likeCount.innerHTML);
                        likeCount.innerHTML = previousAction === 'like' ? totalLikes + 1 : totalLikes - 1;

                    }

                })
        });
</script>
{%endblock%}
